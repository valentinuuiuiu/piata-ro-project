{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}AI Assistant - {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">{{ site_header|default:_('Django site admin') }}</a></h1>
{% endblock %}

{% block nav-global %}{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module" style="margin-bottom: 20px;">
        <h2>ðŸ¤– AI Assistant</h2>
        <p>Get intelligent help with database management, marketing optimization, and inventory control.</p>
        
        <!-- Conversation List -->
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h3>Conversations</h3>
                <div id="conversation-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    {% for conv in conversations %}
                    <div class="conversation-item" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;" 
                         onclick="loadConversation({{ conv.id }})">
                        <strong>{{ conv.title }}</strong>
                        <br>
                        <small>{{ conv.updated_at|date:"M d, Y H:i" }}</small>
                    </div>
                    {% empty %}
                    <p>No conversations yet. Start a new one!</p>
                    {% endfor %}
                </div>
                <button onclick="startNewConversation()" class="button" style="margin-top: 10px;">New Conversation</button>
            </div>
            
            <!-- Chat Area -->
            <div style="flex: 2;">
                <div id="chat-area" style="border: 1px solid #ddd; height: 400px; display: flex; flex-direction: column;">
                    {% if active_conversation %}
                    <div style="padding: 10px; border-bottom: 1px solid #ddd;">
                        <h3>{{ active_conversation.title }}</h3>
                    </div>
                    <div id="messages" style="flex: 1; overflow-y: auto; padding: 10px;">
                        {% for msg in messages %}
                        <div style="margin-bottom: 15px;">
                            <strong>{{ msg.role|capfirst }}:</strong>
                            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 5px;">
                                {{ msg.content }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: #666;">
                        Select a conversation or start a new one
                    </div>
                    {% endif %}
                </div>
                
                <!-- Input Area -->
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <input type="text" id="message-input" placeholder="Type your message..." 
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()" class="button">Send</button>
                </div>
                
                <!-- Status -->
                <div id="status" style="margin-top: 10px; color: #666;"></div>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversationId = {% if active_conversation %}{{ active_conversation.id }}{% else %}null{% endif %};

function loadConversation(conversationId) {
    currentConversationId = conversationId;
    window.location.href = '/ai-assistant/?conversation=' + conversationId;
}

function startNewConversation() {
    fetch('/ai-assistant/new/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.conversation_id) {
            loadConversation(data.conversation_id);
        }
    })
    .catch(error => console.error('Error:', error));
}

function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    const status = document.getElementById('status');
    status.textContent = 'Sending...';
    
    // Add user message to UI
    addMessage('user', message);
    input.value = '';
    
    fetch('/ai-assistant/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
            message: message,
            conversation_id: currentConversationId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addMessage('assistant', data.response);
            status.textContent = '';
            
            // Update conversation title if it's new
            if (data.conversation_id && !currentConversationId) {
                currentConversationId = data.conversation_id;
            }
        } else {
            status.textContent = 'Error: ' + (data.error || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        status.textContent = 'Error sending message';
    });
}

function addMessage(role, content) {
    const messagesDiv = document.getElementById('messages');
    if (!messagesDiv) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.style.marginBottom = '15px';
    
    const roleSpan = document.createElement('strong');
    roleSpan.textContent = role.charAt(0).toUpperCase() + role.slice(1) + ':';
    
    const contentDiv = document.createElement('div');
    contentDiv.style.background = role === 'user' ? '#e3f2fd' : '#f0f0f0';
    contentDiv.style.padding = '10px';
    contentDiv.style.borderRadius = '5px';
    contentDiv.style.marginTop = '5px';
    contentDiv.textContent = content;
    
    messageDiv.appendChild(roleSpan);
    messageDiv.appendChild(contentDiv);
    messagesDiv.appendChild(messageDiv);
    
    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Check MCP status
function checkMCPStatus() {
    fetch('/ai-assistant/status/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                document.getElementById('status').textContent = 'MCP Orchestrator: Online';
                document.getElementById('status').style.color = 'green';
            }
        })
        .catch(error => {
            console.error('Status check failed:', error);
        });
}

// Check status on load
document.addEventListener('DOMContentLoaded', checkMCPStatus);
</script>
{% endblock %}
